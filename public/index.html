<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>BYD KDS - Operasyon & Siting Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* TEMEL STÄ°LLER (SENÄ°N KODUNLA AYNI) */
    body { margin:0; font-family: "Inter","Segoe UI",sans-serif; background: radial-gradient(circle at top left,#0b1220,#0f1724); color:#e6eef8; overflow:hidden; }
    .container { display:flex; height:100vh; gap:12px; padding:12px; box-sizing:border-box; }
    .left { width:35%; min-width:340px; background:rgba(10,16,28,.98); border-radius:12px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,.5); overflow:auto; scrollbar-width:thin; scrollbar-color:#233 #0b1220; }
    .right { width:65%; position:relative; border-radius:12px; overflow:hidden; }
    #map { position:absolute; inset:0; border-radius:12px; }
    h1 { font-size:1.35rem; font-weight:600; color:#0ea5a4; text-shadow:0 0 6px rgba(14,165,164,.5); margin:0 0 12px 0; }
    .controls { margin-bottom:14px; }
    label { display:block; font-size:.9rem; margin-bottom:6px; color:#bcd; }
    select, input[type="text"], input[type="number"] { /* Input type'larÄ± belirtildi */
        width:100%; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,.08); background:#031223; color:#e6eef8; transition:.25s; box-sizing: border-box;
    }
    input[type="range"] { width: 100%; cursor: pointer; } /* Slider stili */
    select:focus, input:focus { outline:none; border-color:#0ea5a4; box-shadow:0 0 4px #0ea5a4; }
    button { padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; transition:.3s; }
    .btn-primary { background:linear-gradient(90deg,#0ea5a4,#00c6cf); color:#001a1a; border:none; }
    .btn-primary:hover { transform:scale(1.02); box-shadow:0 0 10px #0ea5a4; }
    .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,.1); color:#e6eef8; }
    .btn-ghost:hover { border-color:#0ea5a4; color:#0ea5a4; }
    .section-title { color:#0ea5a4; font-weight:600; border-bottom:1px solid rgba(255,255,255,.1); margin-top:12px; padding-bottom:4px; }

     /* KPI (SENÄ°N KODUNLA AYNI - Sparkline YOK) */
    .kpi-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 10px 0 12px; }
    .kpi { background: #07182a; padding: 10px 12px; border-radius: 8px; box-shadow: inset 0 0 10px rgba(14, 165, 164, .2); transition: .3s; }
    .kpi:hover { transform: translateY(-3px); background: #0a2136; }
    .kpi .title { font-size: .85rem; color: #a9c1d8; margin-bottom: 3px; }
    .kpi .value { font-size: 1.1rem; font-weight: 700; color: #fff; }

    /* DiÄŸer stiller (SENÄ°N KODUNLA AYNI) */
    .site-list { margin-top:10px; }
    .site-item { padding:10px; border-radius:8px; background:rgba(7,20,33,.9); margin-bottom:8px; border-left:4px solid transparent; transition:.3s; cursor:pointer; }
    .site-item:hover { border-left-color:#0ea5a4; background:#0e1b2c; }
    .score { font-weight:700; color:#ffdd57; float:right; }
    .small { font-size:.85rem; color:#a9c1d8; }
    .legend { position:absolute; left:12px; bottom:12px; z-index:999; background:rgba(7,18,26,.95); padding:8px; border-radius:6px; font-size:.85rem; color:#cfe; box-shadow:0 0 10px rgba(0,0,0,.5); }
    .cards { display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px; }
    .card { background:#0b1526;
    border:1px solid rgba(255,255,255,.05);
    border-radius:10px;
    padding:10px;
    height: 280px; /* Sabit yÃ¼kseklik - SORUN BURADA */
    position: relative;
    overflow: hidden;}
    .card h4 { margin:0 0 8px 0; font-size:1rem; color:#cfe; }
    .card canvas { width: 100%;} /* Grafik boyutu ayarlandÄ± */
    .card {
    background:#0b1526;
    border:1px solid rgba(255,255,255,.05);
    border-radius:10px;
    padding:10px;
    height: 355px; /* Sabit yÃ¼kseklik verdik */
    position: relative; /* Chart.js'in doÄŸru konumlanmasÄ± iÃ§in */
    overflow: hidden; /* TaÅŸmalarÄ± engellemek iÃ§in eklenebilir */
}
    .tabs { display:flex; gap:6px; margin-bottom:12px; flex-wrap: wrap;} /* Wrap eklendi */
    .tab-btn { flex: 1 1 auto; text-align:center; padding:8px; border-radius:8px; cursor:pointer; border:1px solid rgba(255,255,255,.1); background:#07182a; color:#cfe; font-weight:600; transition:.25s; font-size: 0.75rem; min-width: 80px;} /* Boyut ayarlandÄ± */
    .tab-btn.active { background:#0ea5a4; color:#001a1a; box-shadow:0 0 8px #0ea5a4; }
    .section { display:none; }
    .section.active { display:block; }
    .detail-table-container { max-height: 70vh; overflow-y: auto; margin-top: 10px; }
    .detail-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .detail-table th, .detail-table td { padding: 6px 4px; border: 1px solid rgba(255,255,255,.1); text-align: left; }
    .detail-table th { background: #0a2136; color: #0ea5a4; position: sticky; top: 0; }
    .detail-table tr:nth-child(even) { background: #0b1526; }
    .detail-table td[data-label="Risk"] { color: #f43f5e; }
    .detail-table td[data-label="TeÅŸvik"] { color: #34d399; }
    .detail-table td[data-label="Maliyet"] { color: #f59e0b; }

    /* ARAÅTIRMA/DETAY PANELÄ° STÄ°LLERÄ° (SENÄ°N KODUNLA AYNI) */
    .btn-back { background: #0a2136; color: #0ea5a4; border: 1px solid #0ea5a4; width: 100%; margin-bottom: 10px; }
    .btn-back:hover { background: #0ea5a4; color: #001a1a; }
    .detail-panel-body { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 15px; font-size: 0.9rem; }
    .detail-panel-body .m-item { background: #07182a; padding: 8px; border-radius: 6px; }
    .detail-panel-body .m-title { font-size: 0.8rem; color: #a9c1d8; margin-bottom: 3px; }
    .detail-panel-body .m-value { font-weight: 600; }
    .detail-panel-body .m-value.risk { color: #f43f5e; }
    .detail-panel-body .m-value.incentive { color: #34d399; }
    .detail-panel-body .m-value.cost { color: #f59e0b; }
    .siting-subpanel { display: none; }
    .siting-subpanel.active { display: block; }

    /* YENÄ°: SimÃ¼lasyon Paneli Stilleri */
    .sim-group { margin-bottom: 15px; background: #0b1526; padding: 10px; border-radius: 8px; border: 1px solid rgba(14,165,164,.2);}
    .sim-group h4 { margin: 0 0 10px 0; color: #cde; font-size: 0.95rem;}
    .sim-group label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 0.85rem;}
    .sim-group label span:last-child { font-weight: bold; color: #ffdd57; min-width: 40px; text-align: right; }
    #simResultsList .site-item { background: rgba(11, 21, 38, 0.9); }
    #simResultsList .score-change { font-size: 0.8rem; margin-left: 10px; }
    #simResultsList .score-change.positive { color: #34d399; }
    #simResultsList .score-change.negative { color: #f43f5e; }

  </style>
</head>
<body>
  <div class="container">
    <div class="left">
      <h1>BYD KDS â€” Operasyon & Fabrika Karar Destek Sistemi</h1>

      <div class="tabs">
        <div class="tab-btn active" data-target="analizSection">ğŸ  Ana Sayfa</div>
        <div class="tab-btn" data-target="sitingSection">ğŸ­ Fabrika Analizi</div>
        <div class="tab-btn" data-target="simulationSection">ğŸ”® SimÃ¼lasyon</div> <div class="tab-btn" data-target="detailsSection">ğŸ“‘ DetaylÄ± Veri</div>
        <div class="tab-btn" data-target="chartsSection">ğŸ“ˆ Grafikler</div>
        <div class="tab-btn" data-target="reportingSection">ğŸ“Š Raporlama</div>
        <div class="tab-btn" data-target="dealersSection">ğŸª Bayiler</div>
      </div>

      <div id="analizSection" class="section active">
        <div class="controls">
          <label for="cityFilter">Åehir Filtrele</label>
          <select id="cityFilter"><option value="">TÃ¼m Åehirler</option></select>
          <label for="modelFilter">AraÃ§ Modeli</label>
          <select id="modelFilter"><option value="">TÃ¼m Modeller</option></select>
        </div>
        <div class="section-title">KPI GÃ¶stergeleri</div>
        <div class="kpi-row">
            <div class="kpi"><div class="title">Toplam SipariÅŸ</div><div class="value" id="kpiOrders">â€”</div></div>
            <div class="kpi"><div class="title">Ortalama Gecikme (dk)</div><div class="value" id="kpiDelay">â€”</div></div>
            <div class="kpi"><div class="title">On-Time Teslim (%)</div><div class="value" id="kpiOnTime">â€”</div></div>
            <div class="kpi"><div class="title">Toplam Stok (Adet)</div><div class="value" id="kpiStock">â€”</div></div>
        </div>
        <h3 style="margin-top:6px;">HÄ±zlÄ± EriÅŸim: Aday Lokasyonlar (sÄ±ralÄ±)</h3>
        <div id="siteList" class="site-list"></div>
        <footer>Demo veriler sahte - KDS Ã¶zellikleri uyarÄ±nca (analitik, interaktif, veri+model tabanlÄ±).</footer>
      </div>

      <div id="sitingSection" class="section">
        <div id="sitingListPanel" class="siting-subpanel active">
            <div class="section-title">Fabrika Yeri Kriter AÄŸÄ±rlÄ±klarÄ±</div>
            <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px; font-size:0.8rem; text-align:center; color:#a9c1d8;">
               <span>Talep</span><span>Arsa</span><span>Ä°ÅŸgÃ¼cÃ¼</span><span>AltyapÄ±</span><span>Tedarik</span>
            </div>
            <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;">
              <input type="number" step="0.01" id="wDemand" placeholder="0.30" value="0.30" />
              <input type="number" step="0.01" id="wLand" placeholder="0.15" value="0.15" />
              <input type="number" step="0.01" id="wLabor" placeholder="0.10" value="0.10" />
              <input type="number" step="0.01" id="wInfra" placeholder="0.15" value="0.15" />
              <input type="number" step="0.01" id="wSupplier" placeholder="0.10" value="0.10" />
            </div>
            <div style="display:flex;gap:8px;margin-top:8px;">
              <button id="runSiting" class="btn-primary" style="flex:1;">Analizi BaÅŸlat</button>
              <button id="refresh" class="btn-ghost" style="flex:1;">Yenile</button>
            </div>
            <div class="section-title">Fabrika Yeri Analizi SonuÃ§larÄ±</div>
            <div id="siteList_siting" class="site-list"></div>
        </div>
        <div id="sitingDetailPanel" class="siting-subpanel">
            <button id="btnBackToList" class="btn-back"> &larr; Listeye Geri DÃ¶n</button>
            <h2 id="detailPanelTitle" style="color:#0ea5a4; margin-top:0;">Detay</h2>
            <div id="detailPanelBody" class="detail-panel-body"></div>
        </div>
      </div>

      <div id="simulationSection" class="section">
          <div class="section-title">SimÃ¼lasyon Parametreleri</div>

          <div class="sim-group">
              <h4>Kriter AÄŸÄ±rlÄ±klarÄ±nÄ± SimÃ¼le Et ("What-If" Analizi)</h4>
              <label for="sim_wDemand">Talep AÄŸÄ±rlÄ±ÄŸÄ±: <span id="sim_wDemand_val">0.30</span></label>
              <input type="range" id="sim_wDemand" min="0" max="1" step="0.05" value="0.30" oninput="updateSliderLabel('sim_wDemand')">

              <label for="sim_wLand">Arsa Maliyeti AÄŸÄ±rlÄ±ÄŸÄ±: <span id="sim_wLand_val">0.15</span></label>
              <input type="range" id="sim_wLand" min="0" max="1" step="0.05" value="0.15" oninput="updateSliderLabel('sim_wLand')">
              
              <label for="sim_wLabor">Ä°ÅŸgÃ¼cÃ¼ AÄŸÄ±rlÄ±ÄŸÄ±: <span id="sim_wLabor_val">0.10</span></label>
              <input type="range" id="sim_wLabor" min="0" max="1" step="0.05" value="0.10" oninput="updateSliderLabel('sim_wLabor')">

              <label for="sim_wInfra">AltyapÄ± AÄŸÄ±rlÄ±ÄŸÄ±: <span id="sim_wInfra_val">0.15</span></label>
              <input type="range" id="sim_wInfra" min="0" max="1" step="0.05" value="0.15" oninput="updateSliderLabel('sim_wInfra')">

              <label for="sim_wSupplier">TedarikÃ§i YakÄ±nlÄ±ÄŸÄ± AÄŸÄ±rlÄ±ÄŸÄ±: <span id="sim_wSupplier_val">0.10</span></label>
              <input type="range" id="sim_wSupplier" min="0" max="1" step="0.05" value="0.10" oninput="updateSliderLabel('sim_wSupplier')">
              <small style="color:#a9c1d8; display:block; text-align:center;">(Ã–nem derecesini ayarlayÄ±n)</small>
          </div>

          <div class="sim-group">
              <h4>BÃ¶lgesel Arsa Maliyet DeÄŸiÅŸimini SimÃ¼le Et</h4>
               <label for="sim_region">Etkilenecek BÃ¶lge:</label>
               <select id="sim_region">
                   <option value="">BÃ¶lge SeÃ§ilmedi</option>
                   <option value="Marmara">Marmara</option>
                   <option value="Ege">Ege</option>
                   <option value="Ä°Ã§ Anadolu">Ä°Ã§ Anadolu</option>
                   <option value="Akdeniz">Akdeniz</option>
                   <option value="Karadeniz">Karadeniz</option>
                   <option value="GÃ¼neydoÄŸu">GÃ¼neydoÄŸu</option>
               </select>
               <label for="sim_costChangePct">Maliyet DeÄŸiÅŸim OranÄ± (%):</label>
               <input type="number" id="sim_costChangePct" placeholder="Ã–rn: 20 (artÄ±ÅŸ) veya -10 (azalÄ±ÅŸ)" value="0">
          </div>

          <button id="runSimulation" class="btn-primary" style="width:100%; margin-top:10px;">SimÃ¼lasyonu Ã‡alÄ±ÅŸtÄ±r</button>

          <div class="section-title" style="margin-top: 15px;">SimÃ¼lasyon SonuÃ§larÄ± (Yeni SÄ±ralama)</div>
          <div id="simResultsList" class="site-list">
              <p style="text-align:center; color:#a9c1d8;">SimÃ¼lasyonu Ã§alÄ±ÅŸtÄ±rmak iÃ§in yukarÄ±daki parametreleri ayarlayÄ±n.</p>
          </div>
      </div>

      <div id="detailsSection" class="section">
        <div class="section-title">TÃ¼m Aday Sahalar (KarÅŸÄ±laÅŸtÄ±rmalÄ± Veri GÃ¶rÃ¼nÃ¼mÃ¼)</div>
        <div class="detail-table-container">
          <table class="detail-table">
            <thead>
              <tr><th>Saha</th><th>Åehir</th><th>Maliyet (â‚º/mÂ²)</th><th>Ä°ÅŸgÃ¼cÃ¼</th><th>AltyapÄ±</th><th>Lojistik</th><th>Tedarik (km)</th><th>Stok</th><th>Talep</th><th>Deprem (%)</th><th>TeÅŸvik</th></tr>
            </thead>
            <tbody id="detailTableBody"></tbody>
          </table>
        </div>
      </div>
<div id="reportingSection" class="section">
    <div class="section-title">HazÄ±rlanan Raporlar</div>
    <div class="controls" style="display:flex; gap:10px; margin-bottom:15px;">
        <button onclick="downloadReport('csv')" class="btn-ghost" style="flex:1;">ğŸ“‚ CSV Olarak Ä°ndir</button>
        <button onclick="downloadReport('pdf')" class="btn-primary" style="flex:1;">ğŸ“„ PDF Olarak Ä°ndir</button>
    </div>
    <div id="reportList" class="site-list">
        <p style="text-align:center; color:#a9c1d8;">HenÃ¼z rapora eklenmiÅŸ bir sonuÃ§ yok.</p>
    </div>
</div>
      <div id="chartsSection" class="section">
        <div class="section-title">Grafikler</div>
        <div class="cards">
          <div class="card"><h4 style="margin: 0;">Model BazlÄ± SatÄ±ÅŸlar</h4><canvas id="modelChart"></canvas></div>
          <div class="card"><h4 style="margin: 0;">Åehir BazlÄ± SipariÅŸ</h4><canvas id="cityChart"></canvas></div>
        </div>
      </div>

      <div id="dealersSection" class="section">
        <div class="section-title">Bayiler</div>
        <div id="dealerList_menu" class="site-list"></div>
      </div>
    </div>

    <div class="right">
      <div id="map"></div>
      
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    let selectedReports = [];

function addToReport(name, score, cost) {
    selectedReports.push({ name, score, cost });
    updateReportUI();
    alert(name + " rapora eklendi.");
}

function updateReportUI() {
    const reportList = document.getElementById('reportList');
    if (selectedReports.length === 0) return;
    
    reportList.innerHTML = selectedReports.map((r, index) => `
        <div class="site-item">
            <span style="float:right; cursor:pointer; color:#f43f5e;" onclick="removeFromReport(${index})">ğŸ—‘ï¸</span>
            <b>${r.name}</b><br>
            <span class="small">Skor: ${r.score} | Maliyet: ${fmtTL(r.cost)}</span>
        </div>
    `).join('');
}

function removeFromReport(index) {
    selectedReports.splice(index, 1);
    updateReportUI();
}

async function downloadReport(format) {
    if (selectedReports.length === 0) return alert("Ã–nce rapora bir ÅŸeyler eklemelisiniz!");

    if (format === 'pdf') {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // PDF BaÅŸlÄ±ÄŸÄ±
        doc.setFontSize(18);
        doc.text("BYD KDS - Simulasyon Sonuc Raporu", 10, 20);
        doc.setFontSize(12);
        doc.text(`Tarih: ${new Date().toLocaleString()}`, 10, 30);
        doc.line(10, 35, 200, 35); // Ã‡izgi Ã§ek

        // Verileri YazdÄ±r
        let y = 45;
        selectedReports.forEach((r, index) => {
            if (y > 280) { doc.addPage(); y = 20; } // Sayfa dolarsa yeni sayfa aÃ§
            doc.text(`${index + 1}. Lokasyon: ${r.name}`, 10, y);
            doc.text(`   Skor: ${r.score} | Maliyet: ${r.cost} TL`, 10, y + 7);
            y += 20;
        });

        doc.save("BYD_KDS_Analiz_Raporu.pdf");
    } else {
        // CSV indirme mantÄ±ÄŸÄ± aynen kalsÄ±n
        const response = await fetch(`/api/export_report?format=${format}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: selectedReports })
        });
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `BYD_KDS_Rapor.${format}`;
        document.body.appendChild(a);
        a.click();
        a.remove();
    }
}

    // API adresi
    const apiBase = location.origin.includes('file:') ? 'http://localhost:3000' : location.origin;
    async function fetchJson(path, options = {}){
        const response = await fetch(apiBase + path, options);
        if (!response.ok) {
           const errorText = await response.text();
           console.error(`API Error (${response.status}) [${options.method || 'GET'} ${path}]:`, errorText);
           throw new Error(`API isteÄŸi baÅŸarÄ±sÄ±z: ${response.status}`);
        }
        const text = await response.text();
        // BoÅŸ cevaplarÄ± veya geÃ§erli olmayan JSON'larÄ± kontrol et
        if (!text) {
             console.warn(`API'dan boÅŸ cevap geldi: ${path}`);
             return null; // Veya {} gibi uygun bir varsayÄ±lan
        }
        try { return JSON.parse(text); }
        catch (e) { console.error(`API'dan geÃ§erli JSON gelmedi: ${path}`, text); return null; }
    }


    // HARÄ°TA
    const turkeyBounds = L.latLngBounds([35.5, 25.5], [42.5, 45.0]);
    const map = L.map('map', { zoomControl: true, minZoom: 6, maxZoom: 12, maxBounds: turkeyBounds, maxBoundsViscosity: 1.0 }).setView([39.0, 35.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
    const dealerLayer = L.layerGroup().addTo(map);
    const siteLayer = L.layerGroup().addTo(map);

    // UI ReferanslarÄ±
    const cityFilter = document.getElementById('cityFilter');
    const modelFilter = document.getElementById('modelFilter');
    const siteList = document.getElementById('siteList');
    const kpiOrders = document.getElementById('kpiOrders');
    const kpiDelay = document.getElementById('kpiDelay');
    const kpiOnTime = document.getElementById('kpiOnTime');
    const kpiStock = document.getElementById('kpiStock');
    const siteListSiting = document.getElementById('siteList_siting');
    const dealerListMenu = document.getElementById('dealerList_menu');
    const detailTableBody = document.getElementById('detailTableBody');
    const sitingListPanel = document.getElementById('sitingListPanel');
    const sitingDetailPanel = document.getElementById('sitingDetailPanel');
    const detailPanelTitle = document.getElementById('detailPanelTitle');
    const detailPanelBody = document.getElementById('detailPanelBody');
    const simResultsList = document.getElementById('simResultsList'); // Yeni SimÃ¼lasyon listesi

    let modelChart, cityChart;
    const dealerMarkers = new Map();
    const siteMarkers = new Map();
    let baseSiteScores = []; // SimÃ¼lasyon karÅŸÄ±laÅŸtÄ±rmasÄ± iÃ§in

    // Sekme DeÄŸiÅŸtirme
    function switchTab(targetId) {
        document.querySelectorAll('.tab-btn').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        const tabButton = document.querySelector(`.tab-btn[data-target="${targetId}"]`);
        if (tabButton) tabButton.classList.add('active');
        const section = document.getElementById(targetId);
        if (section) section.classList.add('active');
    }
    document.querySelectorAll('.tab-btn').forEach(tab=>{
        tab.addEventListener('click', ()=>{
            showSitingList(); // BaÅŸka sekmeye geÃ§ince detay panelini kapat
            switchTab(tab.dataset.target);
        });
    });

    // Formatlama
    const fmtTL = v => v ? Number(v).toLocaleString('tr-TR', {maximumFractionDigits:0}) + ' â‚º' : 'N/A';
    const fmtPctDirect = v => (v !== null && v !== undefined) ? Math.round(Number(v)) + '%' : 'N/A';

    // AraÅŸtÄ±rma Paneli
    function showSitingList() {
        sitingDetailPanel.classList.remove('active');
        sitingListPanel.classList.add('active');
    }
    async function showSitingDetail(siteId) {
        switchTab('sitingSection'); // Otomatik sekme deÄŸiÅŸtir
        sitingListPanel.classList.remove('active');
        sitingDetailPanel.classList.add('active');
        detailPanelTitle.innerText = "YÃ¼kleniyor...";
        detailPanelBody.innerHTML = "LÃ¼tfen bekleyin...";
        try {
            const s = await fetchJson(`/api/site_detail/${siteId}`);
            if (!s) throw new Error("Veri bulunamadÄ±.");
            detailPanelTitle.innerText = s.site_name;
            detailPanelBody.innerHTML = `
                <div class="m-item"><div class="m-title">Åehir</div><div class="m-value">${s.city_name}</div></div>
                <div class="m-item"><div class="m-title">Arsa Maliyeti (mÂ²)</div><div class="m-value cost">${fmtTL(s.land_cost_per_m2)}</div></div>
                <div class="m-item"><div class="m-title">Ä°ÅŸgÃ¼cÃ¼ Endeksi</div><div class="m-value">${s.labor_index} / 100</div></div>
                <div class="m-item"><div class="m-title">AltyapÄ± Endeksi</div><div class="m-value">${s.altyapi_endeksi} / 100</div></div>
                <div class="m-item"><div class="m-title">Lojistik Endeksi</div><div class="m-value">${s.logistics_index} / 100</div></div>
                <div class="m-item"><div class="m-title">TedarikÃ§i Mesafesi</div><div class="m-value">${s.supplier_proximity_km} km</div></div>
                <div class="m-item"><div class="m-title">TeÅŸvik BÃ¶lgesi</div><div class="m-value incentive">${s.zone_name}</div></div>
                <div class="m-item"><div class="m-title">Vergi Ä°ndirimi</div><div class="m-value incentive">${fmtPctDirect(s.tax_rebate_pct)}</div></div>
                <div class="m-item"><div class="m-title">Deprem Riski</div><div class="m-value risk">${fmtPctDirect(s.earthquake_risk_pct)}</div></div>
                <div class="m-item"><div class="m-title">Sel Riski</div><div class="m-value risk">${fmtPctDirect(s.flood_risk_pct)}</div></div>
                <div class="m-item"><div class="m-title">Åehir Talebi (Pazar)</div><div class="m-value">${s.demand_index || 'N/A'} / 10</div></div>
                <div class="m-item"><div class="m-title">Enerji Kapasitesi</div><div class="m-value">${s.energy_capacity_mw} MW</div></div>`;
            if (s.lat && s.lon) map.flyTo([s.lat, s.lon], 9);
        } catch (error) {
             console.error("Detay gÃ¶sterilemedi:", error);
             detailPanelTitle.innerText = "Hata";
             detailPanelBody.innerHTML = "Detaylar yÃ¼klenirken bir sorun oluÅŸtu.";
        }
    }


    // KPI YÃ¼kleme
    async function loadKPIs() {
        try {
            // API artÄ±k { overall: {...}, byCity: [...] } formatÄ±nda dÃ¶nÃ¼yor
            const kpiData = await fetchJson('/api/kpis');
            if (!kpiData || !kpiData.overall) { throw new Error('KPI verisi alÄ±namadÄ± veya formatÄ± yanlÄ±ÅŸ.'); }
            const kpis = kpiData.overall; // Genel toplamlarÄ± kullan
            kpiOrders.innerText = kpis.total_orders ?? 'N/A';
            kpiDelay.innerText = kpis.avg_delay?.toFixed(2) ?? 'N/A';
            kpiOnTime.innerText = kpis.on_time_rate?.toFixed(1) + '%' ?? 'N/A';
            kpiStock.innerText = kpis.total_stock ?? 'N/A';
        } catch (error) {
            console.error("KPI yÃ¼klenemedi:", error);
            kpiOrders.innerText = kpiDelay.innerText = kpiOnTime.innerText = kpiStock.innerText = 'Hata';
        }
    }
    async function loadPotentialCities() {
    try {
        const potentialCities = await fetchJson('/api/potential_cities');
        potentialLayer.clearLayers();

        potentialCities.forEach(city => {
            // Bayi olmayan yerler iÃ§in kÃ¼Ã§Ã¼k gri daireler
            const marker = L.circleMarker([city.lat, city.lon], {
                radius: 4,
                color: '#7f8c8d', // Gri kenarlÄ±k
                fillColor: '#bdc3c7', // AÃ§Ä±k gri dolgu
                fillOpacity: 0.6,
                weight: 1
            }).addTo(potentialLayer);

            // ÃœstÃ¼ne tÄ±klandÄ±ÄŸÄ±nda aÃ§Ä±lacak Popup ve SimÃ¼lasyon Butonu
            marker.bindPopup(`
                <div style="font-family:sans-serif;">
                    <b style="font-size:14px;">${city.name}</b><br>
                    <span style="color:#666;">Potansiyel Bayi AlanÄ±</span><br><br>
                    <button onclick="startCitySimulation('${city.name}')" 
                            style="width:100%; padding:5px; cursor:pointer; background:#0ea5a4; color:white; border:none; border-radius:4px; font-weight:bold;">
                        Burada Bayi Olsa?
                    </button>
                </div>
            `);
        });
    } catch (e) { console.error("Potansiyel ÅŸehir yÃ¼kleme hatasÄ±:", e); }
}

// SimÃ¼lasyon sekmesine yÃ¶nlendirme fonksiyonu
function startCitySimulation(cityName) {
    switchTab('simulationSection'); 
    console.log(cityName + " iÃ§in analiz baÅŸlatÄ±ldÄ±.");
}

function startCitySimulation(cityName) {
    switchTab('simulationSection'); 
    console.log(cityName + " iÃ§in simÃ¼lasyon baÅŸlatÄ±ldÄ±.");
}
    // Ana YÃ¼kleme
    async function loadAndRender() {
      console.log("loadAndRender baÅŸlÄ±yor...");
      try {
          const [dealers, models] = await Promise.all([
              fetchJson('/api/dealers'),
              fetchJson('/api/vehicle_model').catch(()=>null)
          ]);
          console.log("Bayiler ve Modeller yÃ¼klendi.");

          const cities = [...new Set(dealers.map(d=>d.city))].sort();
          cityFilter.innerHTML = '<option value="">TÃ¼m Åehirler</option>' + cities.map(c=>`<option value="${c}">${c}</option>`).join('');
          modelFilter.innerHTML = '<option value="">TÃ¼m Modeller</option>';
          if(models) modelFilter.innerHTML += models.map(m=>`<option value="${m.id}">${m.model_name}</option>`).join('');
          const potentialLayer = L.layerGroup().addTo(map); // Gri noktalar iÃ§in yeni katman
          dealerLayer.clearLayers();
          dealerListMenu.innerHTML = '';
          dealers.forEach(d=>{
              const popupContent = `<b>${d.name}</b><br>Åehir: ${d.city}<br>BÃ¶lge: ${d.region}`;
              const marker = L.circleMarker([d.lat, d.lon], { radius:7, color:'#2196f3', fillColor:'#2196f3', fillOpacity:0.9 }).bindPopup(popupContent);
              marker.addTo(dealerLayer);
              dealerMarkers.set(d.id || d.name, marker);
              const row = document.createElement('div');
              row.className = 'site-item';
              row.innerHTML = `<b>${d.name}</b> <span class="small">â€” ${d.city}</span>`;
              row.onclick = ()=>{ map.flyTo([d.lat, d.lon], 10); marker.openPopup(); };
              dealerListMenu.appendChild(row);
          });

          console.log("KPI, Grafik ve Detaylar yÃ¼kleniyor...");
          // Hata olasÄ±lÄ±ÄŸÄ±nÄ± azaltmak iÃ§in ayrÄ± ayrÄ± yÃ¼kle
          await loadKPIs();
          await renderCharts();
          await loadDetails();
          await loadPotentialCities();
          console.log("KPI, Grafik ve Detaylar yÃ¼klendi.");

      } catch (error) {
          console.error("Ana veri yÃ¼klenemedi:", error);
          alert("Uygulama yÃ¼klenirken bir hata oluÅŸtu. LÃ¼tfen sayfayÄ± yenileyin veya daha sonra tekrar deneyin.");
      }
      console.log("loadAndRender bitti.");
    }

    // DetaylÄ± Veri Tablosu
    async function loadDetails() {
        detailTableBody.innerHTML = '<tr><td colspan="10" style="text-align:center;">YÃ¼kleniyor...</td></tr>';
        try {
            const details = await fetchJson('/api/all_site_details');
            if(!details || details.length === 0) { detailTableBody.innerHTML = '<tr><td colspan="10">Veri yok.</td></tr>'; return; }
            // index.html iÃ§indeki loadDetails fonksiyonunun iÃ§i:

detailTableBody.innerHTML = details.map(s => `
    <tr>
        <td>${s.site_name}</td>
        <td>${s.city_name}</td>
        <td>${fmtTL(s.land_cost_per_m2)}</td>
        <td>${s.labor_index}</td>
        <td>${s.altyapi_endeksi}</td>
        <td>${s.logistics_index}</td>
        <td>${s.supplier_proximity_km} km</td>
        
        <td style="font-weight:bold; color:${(s.city_stock || 0) < 50 ? '#f43f5e' : '#34d399'}">
            ${s.city_stock !== undefined ? s.city_stock : 0} Adet
        </td>

        <td>${s.demand_index || 'N/A'}</td>
        <td>${fmtPctDirect(s.earthquake_risk_pct)}</td>
        <td>${s.zone_name}</td>
    </tr>`).join('');
        } catch (error) {
             console.error("Detay tablosu yÃ¼klenemedi:", error);
             detailTableBody.innerHTML = '<tr><td colspan="10" style="text-align:center; color: #f43f5e;">Veri yÃ¼klenirken hata oluÅŸtu.</td></tr>';
        }
    }

    // Grafikler
    async function renderCharts(){
      
      console.log("renderCharts baÅŸlÄ±yor...");
      try {
          // Model verisini Ã§ek
          const modelData = await fetchJson('/api/sales_by_model');
          if (!modelData) throw new Error("Model satÄ±ÅŸ verisi alÄ±namadÄ±.");

          // Model Chart
          const mLabels = modelData.map(x=>x.model);
          const mValues = modelData.map(x=>x.orders);
          if(modelChart) modelChart.destroy();
          const ctx1 = document.getElementById('modelChart').getContext('2d');
          if (ctx1) { // Canvas var mÄ± kontrol et
              modelChart = new Chart(ctx1, { type: 'bar', data: { labels: mLabels, datasets: [{ label: 'Teslim Edilen SipariÅŸ', data: mValues, backgroundColor: '#0ea5a4' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color:'#cfe'} }, y: { ticks: { color:'#cfe'} } } } });
          }

          // Åehir bazlÄ± sipariÅŸ iÃ§in KPI verisini kullan
          const kpiData = await fetchJson('/api/kpis'); // Tekrar Ã§ekmek yerine saklanabilir de
          if (kpiData && kpiData.byCity){
              const cLabels = kpiData.byCity.map(x=>x.city);
              const cValues = kpiData.byCity.map(x=>x.total_orders);
              if(cityChart) cityChart.destroy();
              const ctx2 = document.getElementById('cityChart').getContext('2d');
              if(ctx2) { // Canvas var mÄ± kontrol et
                  cityChart = new Chart(ctx2, { type: 'doughnut', data: { labels: cLabels, datasets: [{ data: cValues }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position:'bottom', labels:{ color:'#cfe' } } } } });
              }
          }
          console.log("Grafikler Ã§izildi.");

      } catch(error) {
          console.error("Grafikler yÃ¼klenemedi:", error);
          // Ä°steÄŸe baÄŸlÄ±: Grafik alanlarÄ±nda hata mesajÄ± gÃ¶ster
          const ctx1 = document.getElementById('modelChart');
          if (ctx1) ctx1.parentElement.innerHTML = '<p style="color: red; text-align: center;">Grafik yÃ¼klenemedi.</p>';
          const ctx2 = document.getElementById('cityChart');
          if (ctx2) ctx2.parentElement.innerHTML = '<p style="color: red; text-align: center;">Grafik yÃ¼klenemedi.</p>';
      }
    }


    // Fabrika Yeri Analizi (Siting)
    async function runSiting() {
      console.log("runSiting baÅŸlÄ±yor...");
      siteList.innerHTML = siteListSiting.innerHTML = '<p style="text-align:center; color:#a9c1d8;">Analiz Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...</p>';
      siteLayer.clearLayers();
      siteMarkers.clear();

      const wDemand   = document.getElementById('wDemand').value || '0.30';
      const wLand     = document.getElementById('wLand').value || '0.15';
      const wLabor    = document.getElementById('wLabor').value || '0.10';
      const wInfra    = document.getElementById('wInfra').value || '0.15';
      const wSupplier = document.getElementById('wSupplier').value || '0.10';
      const qs = `?w_demand=${wDemand}&w_land=${wLand}&w_labor=${wLabor}&w_infra=${wInfra}&w_supplier=${wSupplier}`;

      try {
          const payload = await fetchJson('/api/score_sites' + qs);
          if (!payload || !payload.results) throw new Error("API'dan geÃ§erli sonuÃ§ gelmedi.");
          console.log("Skorlar alÄ±ndÄ±:", payload.results.length);

          baseSiteScores = payload.results.map(s => ({ id: s.id, score: s.score }));

          siteList.innerHTML = ''; // Temizle
          siteListSiting.innerHTML = ''; // Temizle

          if (payload.results.length === 0) {
              siteList.innerHTML = siteListSiting.innerHTML = '<p style="text-align:center; color:#a9c1d8;">Analiz sonucu bulunamadÄ±.</p>';
              return;
          }

          payload.results.forEach(s=>{
              const color = (s.score ?? 0) >= 70 ? '#16a34a' : ((s.score ?? 0) >= 45 ? '#f59e0b' : '#ef4444');
              const cost = Number(s.land_cost_per_m2).toFixed(0); // NaN kontrolÃ¼ server.js'de yapÄ±lÄ±yor varsayÄ±mÄ±
              const infraPct = s.altyapi_endeksi;

              // Lat/Lon kontrolÃ¼ ekle
              if (s.lat != null && s.lon != null) {
                  const marker = L.marker([s.lat, s.lon], { title: s.name });
                  marker.addTo(siteLayer);
                  marker.on('click', () => showSitingDetail(s.id));
                  const radius = 5000 + 25000 * ((s.score || 0)/100);
                  L.circle([s.lat, s.lon], { radius: radius, color, fillOpacity: 0.1, weight:1 }).addTo(siteLayer);
                  siteMarkers.set(s.id, marker);
              } else {
                  console.warn(`Site ID ${s.id} (${s.name}) iÃ§in konum bilgisi eksik.`);
              }


              const itemHTML = `<div><b>${s.name}</b><span class="score">${s.score?.toFixed(2) ?? 'N/A'}</span></div><div class="small">Arsa: ${fmtTL(s.land_cost_per_m2)} â€¢ Ä°ÅŸgÃ¼cÃ¼: ${s.labor_index} â€¢ AltyapÄ±: ${infraPct}</div>`;

              const createItemElement = (htmlTarget) => {
                  const el = document.createElement('div');
                  el.className = 'site-item';
                  el.innerHTML = itemHTML;
                  el.onclick = () => showSitingDetail(s.id);
                  htmlTarget.appendChild(el);
              };
              createItemElement(siteList);
              createItemElement(siteListSiting);
          });

          // HaritayÄ± sitelere gÃ¶re ayarla
           try {
              if (siteLayer.getLayers().length > 0) {
                  map.fitBounds(siteLayer.getBounds().pad(0.1));
              } else if (dealerLayer.getLayers().length > 0) {
                   // Site yoksa bayilere odaklan
                   map.fitBounds(dealerLayer.getBounds().pad(0.3));
              }
           } catch(e) { console.warn("Harita fitBounds hatasÄ±:", e); }

      } catch (error) {
          console.error("Fabrika analizi baÅŸarÄ±sÄ±z:", error);
          siteList.innerHTML = siteListSiting.innerHTML = '<p style="text-align:center; color: #f43f5e;">Analiz sÄ±rasÄ±nda hata oluÅŸtu.</p>';
      }
      console.log("runSiting bitti.");
    }

    // === SimÃ¼lasyon FonksiyonlarÄ± ===
    function updateSliderLabel(sliderId) {
        const slider = document.getElementById(sliderId);
        const label = document.getElementById(sliderId + '_val');
        if (slider && label) {
            let value = parseFloat(slider.value);
            // EÄŸer slider ID'si aÄŸÄ±rlÄ±k slider'larÄ±ndan biriyse yÃ¼zde olarak gÃ¶ster
            if (sliderId.startsWith('sim_w')) { // TÃ¼m aÄŸÄ±rlÄ±k slider ID'leri 'sim_w' ile baÅŸlar
                 label.textContent = (value * 100).toFixed(0) + '%';
            } else {
                 // DiÄŸer slider'lar (varsa) normal deÄŸerini gÃ¶sterir (bu Ã¶rnekte yok)
                 label.textContent = value.toFixed(2);
            }
        }
    }
    async function runSimulation() {
    const simResultsList = document.getElementById('simResultsList');
    simResultsList.innerHTML = '<p style="text-align:center; color:#0ea5a4;">Analiz motoru Ã§alÄ±ÅŸÄ±yor, lÃ¼tfen bekleyin...</p>';

    const simWeights = {
        demand: parseFloat(document.getElementById('sim_wDemand').value),
        land: parseFloat(document.getElementById('sim_wLand').value),
        labor: parseFloat(document.getElementById('sim_wLabor').value),
        infra: parseFloat(document.getElementById('sim_wInfra').value),
        supplier: parseFloat(document.getElementById('sim_wSupplier').value),
    };

    const region = document.getElementById('sim_region').value;
    const costChangePct = parseFloat(document.getElementById('sim_costChangePct').value);
    const siteOverrides = {};
    if (region && !isNaN(costChangePct)) {
        siteOverrides.regionCostChange = { region: region, percentage: costChangePct };
    }

    try {
        const payload = await fetchJson('/api/simulate_scoring', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ weights: simWeights, siteOverrides: siteOverrides })
        });

        if (!payload || !payload.results) throw new Error("Veri alÄ±namadÄ±.");

        simResultsList.innerHTML = ''; // Temizle

        payload.results.forEach(s => {
            const el = document.createElement('div');
            el.className = 'site-item';
            
            // "Rapora Ekle" butonuyla birlikte HTML iÃ§eriÄŸi
            el.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <b style="color:#0ea5a4;">${s.name}</b><br>
                        <span class="small">Maliyet: ${fmtTL(s.land_cost_per_m2)} | AltyapÄ±: %${s.altyapi_endeksi}</span>
                    </div>
                    <div style="text-align:right;">
                        <span class="score" style="display:block; font-size:1.2rem; color:#ffdd57;">${s.score.toFixed(2)}</span>
                        <button onclick="addToReport('${s.name.replace(/'/g, "\\'")}', ${s.score}, ${s.land_cost_per_m2})" 
                                style="margin-top:5px; padding:3px 10px; font-size:11px; background:#0ea5a4; color:#000; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">
                            â• Rapora Ekle
                        </button>
                    </div>
                </div>
            `;
            simResultsList.appendChild(el);
        });

    } catch (error) {
        console.error("SimÃ¼lasyon HatasÄ±:", error);
        simResultsList.innerHTML = '<p style="text-align:center; color:#f43f5e;">VeritabanÄ± baÄŸlantÄ±sÄ± veya hesaplama hatasÄ± oluÅŸtu!</p>';
    }
}

    // Eventler
    document.getElementById('runSiting').addEventListener('click', runSiting);
    document.getElementById('refresh').addEventListener('click', loadAndRender);
    document.getElementById('btnBackToList').addEventListener('click', showSitingList);
    document.getElementById('runSimulation').addEventListener('click', runSimulation);

    // Ana YÃ¼kleme
    (async ()=> {
      console.log("Sayfa yÃ¼kleniyor...");
      await loadAndRender(); // Ã–nce genel veriler
      await runSiting();     // Sonra ilk analiz (temel skorlar iÃ§in)
      // SimÃ¼lasyon slider etiketlerini baÅŸlangÄ±Ã§ta % olarak ayarla
    console.log("SimÃ¼lasyon etiketleri gÃ¼ncelleniyor...");
    const simSliderIds = ['sim_wDemand', 'sim_wLand', 'sim_wLabor', 'sim_wInfra', 'sim_wSupplier'];
    simSliderIds.forEach(sliderId => {
        updateSliderLabel(sliderId); // Her slider iÃ§in formatlama fonksiyonunu Ã§aÄŸÄ±r
    });
    console.log("SimÃ¼lasyon etiketleri gÃ¼ncellendi.");
      console.log("Ä°lk yÃ¼kleme tamamlandÄ±.");
    })();
    // --- FÄ°LTRELEME MANTIÄI ---
    async function applyFilters() {
        const selectedCity = document.getElementById('cityFilter').value;
        const selectedModel = document.getElementById('modelFilter').value;

        try {
            // 1. Bayileri ve KPI'larÄ± yeniden yÃ¼kle/filtrele
            const dealers = await fetchJson('/api/dealers');
            const kpiData = await fetchJson('/api/kpis');

            // Haritadaki bayi katmanÄ±nÄ± temizle
            dealerLayer.clearLayers();

            const filteredDealers = dealers.filter(d => {
                return selectedCity === "" || d.city === selectedCity;
            });

            // FiltrelenmiÅŸ bayileri haritaya ekle
            filteredDealers.forEach(d => {
                const marker = L.circleMarker([d.lat, d.lon], { 
                    radius: 7, color: '#0ea5a4', fillOpacity: 0.8 
                }).addTo(dealerLayer);
                marker.bindPopup(`<b>${d.name}</b><br>${d.city}`);
            });

            // 2. KPI Panellerini GÃ¼ncelle
            if (selectedCity !== "" && kpiData.byCity) {
                const cityKpi = kpiData.byCity.find(c => c.city === selectedCity);
                if (cityKpi) {
                    document.getElementById('kpiOrders').innerText = cityKpi.total_orders;
                    document.getElementById('kpiDelay').innerText = cityKpi.avg_delay_minutes.toFixed(1);
                    document.getElementById('kpiOnTime').innerText = cityKpi.on_time_rate.toFixed(1) + '%';
                }
            } else {
                // Filtre yoksa genel toplamlarÄ± gÃ¶ster
                document.getElementById('kpiOrders').innerText = kpiData.overall.total_orders;
                document.getElementById('kpiDelay').innerText = kpiData.overall.avg_delay.toFixed(1);
                document.getElementById('kpiOnTime').innerText = kpiData.overall.on_time_rate + '%';
            }

            // 3. Åehir seÃ§ildiyse haritayÄ± oraya odakla
            if (selectedCity !== "" && filteredDealers.length > 0) {
                map.flyTo([filteredDealers[0].lat, filteredDealers[0].lon], 9);
            }

        } catch (e) { console.error("Filtreleme hatasÄ±:", e); }
    }

    // SeÃ§im kutularÄ±na olay dinleyicisi (Event Listener) ekle
    document.getElementById('cityFilter').addEventListener('change', applyFilters);
    document.getElementById('modelFilter').addEventListener('change', applyFilters);

    // AraÃ§ modellerini veritabanÄ±ndan Ã§ekip select kutusuna doldur
    async function fillModelFilter() {
        try {
            const models = await fetchJson('/api/vehicle_model');
            const modelSelect = document.getElementById('modelFilter');
            modelSelect.innerHTML = '<option value="">TÃ¼m Modeller</option>';
            models.forEach(m => {
                modelSelect.innerHTML += `<option value="${m.model_name}">${m.model_name}</option>`;
            });
        } catch (e) { console.error("Modeller yÃ¼klenemedi"); }
    }

    // Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda modelleri doldur
    fillModelFilter();
    async function applyFilters() {
        const selectedCity = document.getElementById('cityFilter').value;
        const selectedModel = document.getElementById('modelFilter').value;

        try {
            // Modeli API'ye gÃ¶nderiyoruz
            let kpiUrl = '/api/kpis';
            if (selectedModel !== "") {
                kpiUrl += `?model=${encodeURIComponent(selectedModel)}`;
            }
            
            const kpiData = await fetchJson(kpiUrl);
            const dealers = await fetchJson('/api/dealers');

            // 1. KPI'larÄ± GÃ¼ncelle (ArtÄ±k modele gÃ¶re filtrelenmiÅŸ veri geliyor)
            if (selectedCity !== "" && kpiData.byCity) {
                const cityKpi = kpiData.byCity.find(c => c.city === selectedCity);
                if (cityKpi) {
                    document.getElementById('kpiOrders').innerText = cityKpi.total_orders;
                    document.getElementById('kpiDelay').innerText = cityKpi.avg_delay_minutes.toFixed(1);
                    document.getElementById('kpiOnTime').innerText = cityKpi.on_time_rate.toFixed(1) + '%';
                } else {
                    // Åehirde o modele ait sipariÅŸ yoksa sÄ±fÄ±rla
                    document.getElementById('kpiOrders').innerText = "0";
                    document.getElementById('kpiDelay').innerText = "0";
                    document.getElementById('kpiOnTime').innerText = "0%";
                }
            } else {
                // Åehir seÃ§ili deÄŸilse, gelen genel toplamlarÄ± (modele gÃ¶re sÃ¼zÃ¼lmÃ¼ÅŸ) gÃ¶ster
                document.getElementById('kpiOrders').innerText = kpiData.overall.total_orders;
                document.getElementById('kpiDelay').innerText = kpiData.overall.avg_delay.toFixed(1);
                document.getElementById('kpiOnTime').innerText = kpiData.overall.on_time_rate + '%';
            }

            // 2. HaritayÄ± GÃ¼ncelle (Sadece ÅŸehir filtresi bazlÄ± kalabilir veya modele gÃ¶re bayi de sÃ¼zÃ¼lebilir)
            dealerLayer.clearLayers();
            const filteredDealers = dealers.filter(d => selectedCity === "" || d.city === selectedCity);
            
            filteredDealers.forEach(d => {
                const marker = L.circleMarker([d.lat, d.lon], { radius: 7, color: '#0ea5a4', fillOpacity: 0.8 }).addTo(dealerLayer);
                marker.bindPopup(`<b>${d.name}</b><br>${d.city}`);
            });

            if (selectedCity !== "" && filteredDealers.length > 0) {
                map.flyTo([filteredDealers[0].lat, filteredDealers[0].lon], 9);
            }

        } catch (e) { console.error("Filtreleme hatasÄ±:", e); }
    }
    
  </script>
</body>
</html>
